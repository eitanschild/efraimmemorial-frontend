
<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>פאנל ניהול</title>
  <link rel="icon" href="/favicon.ico?v=1" type="image/x-icon" />
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            givati: '#5C1A7A'
          }
        }
      }
    }
  </script>
  <style>
    body {
      font-family: 'Assistant', sans-serif;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 py-10 px-4">

<div class="max-w-4xl mx-auto">
  <h1 class="text-3xl font-bold text-purple-800 mb-6 text-center">פאנל ניהול</h1>
  <div class="text-center mb-10">
    <button onclick="logout()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition">התנתק</button>
  </div>

  <div id="cloudUsage" class="mb-10 bg-white p-4 rounded-xl shadow text-center text-sm text-gray-700">
    <p class="mb-2 font-semibold">שימוש באחסון ענן (Cloudinary)</p>
    <div class="w-full h-4 bg-gray-200 rounded-full overflow-hidden">
      <div id="usageBar" class="h-4 bg-givati transition-all duration-300 ease-in-out" style="width: 0%"></div>
    </div>
    <p id="usageText" class="mt-2 text-xs text-gray-600"></p>
  </div>

  <h2 class="text-xl font-bold text-center text-blue-900 mb-6">אישור מכתבים וזיכרונות</h2>
  <div id="memoryList" class="space-y-6 mb-12"></div>
  <h2 class="text-xl font-bold text-center text-blue-900 mb-6">מאושרים להצגה</h2>
  <div id="approvedList" class="space-y-6 mb-12"></div>

  <h2 class="text-xl font-bold text-center text-blue-900 mb-6">תמונות ממתינות לאישור</h2>
  <div id="pendingGallery" class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-12"></div>

  <h2 class="text-xl font-bold text-center text-blue-900 mb-6">תמונות מאושרות בגלריה</h2>
  <div id="approvedGallery" class="grid grid-cols-1 sm:grid-cols-2 gap-6"></div>
</div>

<script>
  async function fetchWithAuth(url, options = {}) {
    options.credentials = 'include';
    const res = await fetch(url, options);
    if (res.status === 403) {
      alert('הגישה נדחתה. אנא התחבר מחדש.');
      window.location.href = '/admin.html';
      return [];
    }
    return res.json();
  }

  async function fetchMemories() {
    const pending = await fetchWithAuth('https://efraimemorial-production.up.railway.app/api/pending');
    const approved = await fetchWithAuth('https://efraimemorial-production.up.railway.app/api/memories');

    const pendingContainer = document.getElementById('memoryList');
    const approvedContainer = document.getElementById('approvedList');

    pendingContainer.innerHTML = '';
    approvedContainer.innerHTML = '';

    pending.forEach((memory, index) => {
      const div = document.createElement('div');
      div.className = 'bg-white p-6 rounded-xl shadow space-y-2';
      div.innerHTML = `
        <input id="name-${index}" value="${memory.name}" class="w-full border p-2 rounded" />
        <textarea id="message-${index}" class="w-full border p-2 rounded h-24">${memory.message}</textarea>
        <div class="flex justify-start flex-wrap gap-3 mt-2">
          <button onclick="approveMemory(${index})" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">אשר</button>
          <button onclick="editMemory(${index})" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">ערוך</button>
          <button onclick="deleteMemory(${index})" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">מחק</button>
        </div>
      `;
      pendingContainer.appendChild(div);
    });

    approved.forEach((mem, i) => {
      const div = document.createElement('div');
      div.className = 'bg-white p-6 rounded-xl shadow';
      div.innerHTML = `
        <p class="mb-2"><strong>שם:</strong> ${mem.name}</p>
        <p class="mb-4"><strong>זיכרון:</strong> ${mem.message}</p>
        <button onclick="deleteApproved(${i})" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">מחק</button>
      `;
      approvedContainer.appendChild(div);
    });
  }

  async function fetchGallery() {
    const pending = await fetchWithAuth('https://efraimemorial-production.up.railway.app/api/gallery/pending');
    const approved = await fetchWithAuth('https://efraimemorial-production.up.railway.app/api/gallery/approved');

    const pendingGallery = document.getElementById('pendingGallery');
    const approvedGallery = document.getElementById('approvedGallery');
    pendingGallery.innerHTML = '';
    approvedGallery.innerHTML = '';

    pending.forEach((item, i) => {
      const div = document.createElement('div');
      const src = item.url || `https://efraimemorial-production.up.railway.app/pending-gallery/${item.filename}`;
      div.className = 'bg-white rounded-xl shadow overflow-hidden';
      div.innerHTML = `
        <img src="${src}" class="w-full h-64 object-cover" />
        <div class="p-4">
          <p class="mb-2">${item.caption || ''}</p>
          <div class="flex gap-2">
            <button onclick="approveGallery(${i})" class="bg-green-600 text-white px-3 py-1 rounded">אשר</button>
            <button onclick="deleteGallery(${i})" class="bg-red-600 text-white px-3 py-1 rounded">מחק</button>
          </div>
        </div>
      `;
      pendingGallery.appendChild(div);
    });

    approved.forEach((item, i) => {
      const div = document.createElement('div');
      const src = item.url || `https://efraimemorial-production.up.railway.app/gallery/${item.filename}`;
      div.className = 'bg-white rounded-xl shadow overflow-hidden';
      div.innerHTML = `
        <img src="${src}" class="w-full h-64 object-cover" />
        <div class="p-4">
          <p class="mb-2">${item.caption || ''}</p>
          <button onclick="deleteApprovedGallery(${i})" class="bg-red-600 text-white px-3 py-1 rounded">מחק</button>
        </div>
      `;
      approvedGallery.appendChild(div);
    });
  }

  async function logout() {
    await fetch('https://efraimemorial-production.up.railway.app/logout', {
      method: 'POST',
      credentials: 'include'
    });
    window.location.href = '/admin.html';
  }

  window.addEventListener('DOMContentLoaded', () => {
    fetchMemories();
    fetchGallery();
    loadCloudinaryUsage();
  });

  async function loadCloudinaryUsage() {
    const usage = await fetchWithAuth('https://efraimemorial-production.up.railway.app/api/cloudinary/usage');
    if (!usage || !usage.total_storage_used_bytes) return;

    const usedBytes = usage.total_storage_used_bytes;
    const limitBytes = usage.storage_limit_bytes;
    const percent = ((usedBytes / limitBytes) * 100).toFixed(1);
    const usedGB = (usedBytes / 1e9).toFixed(2);
    const limitGB = (limitBytes / 1e9).toFixed(2);

    document.getElementById('usageBar').style.width = `${percent}%`;
    document.getElementById('usageText').textContent = `${usedGB}GB מתוך ${limitGB}GB בשימוש (${percent}%)`;
  }
</script>

</body>
</html>
